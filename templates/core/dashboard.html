{% extends 'base.html' %}

{% block title %}Dashboard - Pentora{% endblock %}

{% block extra_css %}
<style>
    /* Professional Dashboard Styles */
    .dashboard-container {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        min-height: 100vh;
        padding-top: 1rem;
        padding-bottom: 2rem;
    }

    /* Professional Hero Section */
    .dashboard-hero {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        margin-bottom: 2rem;
        overflow: hidden;
        border: 1px solid rgba(0, 0, 0, 0.05);
    }

    .hero-content {
        padding: 2rem;
    }

    .hero-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .hero-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        overflow: hidden;
        border: 3px solid #e5e7eb;
        flex-shrink: 0;
    }

    .hero-avatar-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .hero-avatar-initials {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 20px;
        color: white;
    }

    .hero-info {
        flex: 1;
        min-width: 0;
    }

    .hero-title {
        font-size: 1.875rem;
        font-weight: 700;
        color: #111827;
        margin: 0 0 0.5rem 0;
        line-height: 1.2;
    }

    .hero-subtitle {
        font-size: 1rem;
        color: #6b7280;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex-wrap: wrap;
    }

    .hero-grade-badge {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Mobile Responsive Hero */
    @media (max-width: 640px) {
        .dashboard-container {
            padding-top: 0.5rem;
        }

        .hero-content {
            padding: 1.5rem;
        }

        .hero-header {
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .hero-avatar {
            width: 56px;
            height: 56px;
        }

        .hero-avatar-initials {
            font-size: 18px;
        }

        .hero-title {
            font-size: 1.5rem;
        }

        .hero-subtitle {
            font-size: 0.875rem;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .hero-content {
            padding: 1rem;
        }

        .hero-title {
            font-size: 1.25rem;
        }

        .hero-avatar {
            width: 48px;
            height: 48px;
        }

        .hero-avatar-initials {
            font-size: 16px;
        }
    }

    .dashboard-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        border: 1px solid #e5e7eb;
        overflow: hidden;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
    }

    .dashboard-card:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    .hero-section {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        color: #1f2937;
        padding: 2rem;
        position: relative;
    }



    .hero-content {
        position: relative;
        z-index: 1;
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .hero-main {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .hero-text {
        flex: 1;
        min-width: 250px;
        text-align: left;
    }

    .hero-stats {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        justify-content: center;
    }

    .stat-card {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0.75rem 1rem;
        text-align: center;
        min-width: 70px;
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
        line-height: 1;
        color: #1f2937;
    }

    .stat-label {
        font-size: 0.75rem;
        color: #6b7280;
        line-height: 1;
    }

    .continue-learning-btn {
        background: #3b82f6;
        border: 1px solid #3b82f6;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 0.875rem;
        white-space: nowrap;
        min-width: 160px;
    }

    .continue-learning-btn:hover {
        background: #2563eb;
        border-color: #2563eb;
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    .subjects-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
        padding: 1.5rem;
    }

    .subject-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        border-left: 4px solid #e2e8f0;
        transition: all 0.3s ease;
        position: relative;
    }

    .subject-card.completed {
        border-left-color: #10b981;
        background: linear-gradient(to right, #f0fdf4, #ffffff);
    }

    .subject-card.in-progress {
        border-left-color: #3b82f6;
        background: linear-gradient(to right, #eff6ff, #ffffff);
    }

    .subject-card.not-started {
        border-left-color: #6b7280;
    }

    .subject-header {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }

    .subject-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .subject-info {
        flex: 1;
    }

    .subject-name {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .subject-progress-text {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .progress-fill.completed {
        background: linear-gradient(90deg, #10b981, #059669);
    }

    .subject-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
    }

    .action-btn {
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        border: none;
        cursor: pointer;
        flex: 1;
        justify-content: center;
    }

    .action-btn.primary {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }

    .action-btn.primary:hover {
        background: linear-gradient(135deg, #2563eb, #1e40af);
        color: white;
        text-decoration: none;
        transform: translateY(-1px);
    }

    .action-btn.secondary {
        background: #f3f4f6;
        color: #374151;
        border: 1px solid #d1d5db;
    }

    .action-btn.secondary:hover {
        background: #e5e7eb;
        color: #374151;
        text-decoration: none;
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .recent-activity {
        padding: 1.5rem;
    }

    .activity-item {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 0.75rem;
        background: #f9fafb;
        transition: all 0.3s ease;
    }

    .activity-item:hover {
        background: #f3f4f6;
    }

    .activity-icon {
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .activity-content {
        flex: 1;
    }

    .activity-title {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .activity-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
    }

    /* Mobile optimizations */
    @media (max-width: 640px) {
        .dashboard-container {
            padding: 0.5rem 0;
        }

        .hero-section {
            padding: 1rem;
        }

        .hero-main {
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .hero-text {
            text-align: center;
            min-width: auto;
        }

        .hero-text h1 {
            font-size: 1.75rem !important;
            margin-bottom: 0.5rem;
        }

        .hero-text p {
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .hero-stats {
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .stat-card {
            padding: 0.5rem 0.75rem;
            min-width: 65px;
            flex: 1;
            max-width: 80px;
        }

        .stat-number {
            font-size: 1.25rem;
        }

        .stat-label {
            font-size: 0.65rem;
        }

        .continue-learning-btn {
            padding: 0.75rem 1.25rem;
            font-size: 0.8rem;
            min-width: 140px;
            margin-top: 0.5rem;
        }

        .subjects-grid {
            grid-template-columns: 1fr;
            padding: 1rem;
            gap: 1rem;
        }

        .subject-card {
            padding: 1rem;
        }

        .subject-actions {
            flex-direction: column;
        }

        .action-btn {
            justify-content: center;
        }
    }

    /* Level Selection Styles */
    .professional-bg {
        background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 50%, #581c87 100%);
        min-height: 100vh;
    }

    .level-selection-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        border: 1px solid #e5e7eb;
    }

    .level-option {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        padding: 1.25rem;
        transition: all 0.2s ease;
        cursor: pointer;
        position: relative;
        text-align: center;
    }

    .level-option:hover {
        border-color: #3b82f6;
        background: #eff6ff;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .level-option.selected {
        border-color: #2563eb;
        background: #dbeafe;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .level-option.selected::after {
        content: 'âœ“';
        position: absolute;
        top: 8px;
        right: 8px;
        background: #2563eb;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }

    .level-number {
        font-size: 1.875rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.25rem;
    }

    .level-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
    }

    .selected .level-number {
        color: #2563eb;
    }

    .selected .level-name {
        color: #1d4ed8;
    }

    .welcome-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .welcome-title {
        font-size: 2rem;
        font-weight: 600;
        color: white;
        margin-bottom: 0.5rem;
    }

    .welcome-subtitle {
        font-size: 1rem;
        color: rgba(255, 255, 255, 0.8);
        max-width: 600px;
        margin: 0 auto;
        line-height: 1.6;
    }

    .submit-button {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 0.875rem 2rem;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.2s ease;
        width: 100%;
        margin-top: 1.5rem;
    }

    .submit-button:hover {
        background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .submit-button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .info-note {
        background: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        text-align: center;
    }

    .info-note p {
        margin: 0;
        font-size: 0.875rem;
        color: #0369a1;
    }
</style>
{% endblock %}

{% block content %}
{% if needs_level_selection %}
<!-- Level Selection (keep existing) -->
<div class="professional-bg">
    <div class="container mx-auto px-2 sm:px-4 py-8 sm:py-12">
        <div class="max-w-4xl mx-auto">
            <!-- Welcome Header -->
            <div class="welcome-header">
                <h1 class="welcome-title">
                    Welcome to Pentora, {{ user.first_name }}!
                </h1>
                <p class="welcome-subtitle">
                    To provide you with the most appropriate learning materials and track your progress effectively, please select your current class level.
                </p>
            </div>

            <!-- Level Selection Form -->
            <div class="level-selection-card p-6 sm:p-8">
                <form method="post" id="levelForm">
                    {% csrf_token %}
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 sm:gap-4">
                        {% for level in class_levels %}
                        <div class="level-option" data-level="{{ level.0 }}" onclick="selectLevel({{ level.0 }})">
                            <div class="level-number">{{ level.0 }}</div>
                            <div class="level-name">{{ level.1 }}</div>
                        </div>
                        {% endfor %}
                    </div>

                    <input type="hidden" name="class_level" id="selectedLevel" value="">
                    <button type="submit" class="submit-button" id="submitBtn" data-custom-loading disabled>
                        Continue to Dashboard
                    </button>

                    <div class="info-note">
                        <p>
                            <i class="fas fa-info-circle mr-2"></i>
                            You can change your class level later in your profile settings.
                        </p>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function selectLevel(level) {
    console.log('Level selected:', level);

    // Remove selected class from all options
    document.querySelectorAll('.level-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Add selected class to clicked option
    event.target.closest('.level-option').classList.add('selected');

    // Set hidden input value
    document.getElementById('selectedLevel').value = level;
    console.log('Hidden input value set to:', document.getElementById('selectedLevel').value);

    // Enable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = false;
    submitBtn.classList.remove('opacity-50');
    console.log('Submit button enabled');
}

function showError(message) {
    // Remove any existing error messages
    const existingError = document.querySelector('.level-selection-error');
    if (existingError) {
        existingError.remove();
    }

    const errorDiv = document.createElement('div');
    errorDiv.className = 'level-selection-error alert alert-error mt-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg';
    errorDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span>${message}</span>
        </div>
    `;

    const form = document.getElementById('levelForm');
    form.insertAdjacentElement('afterend', errorDiv);

    // Remove error after 8 seconds
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 8000);
}

function showSuccess(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'level-selection-success alert alert-success mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg';
    successDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas fa-check-circle mr-2"></i>
            <span>${message}</span>
        </div>
    `;

    const form = document.getElementById('levelForm');
    form.insertAdjacentElement('afterend', successDiv);
}

// Handle form submission with proper loading state and error handling
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('levelForm');
    const submitBtn = document.getElementById('submitBtn');

    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            console.log('Form submission started');

            // Prevent double submission
            if (submitBtn.disabled) {
                console.log('Form submission prevented - button already disabled');
                e.preventDefault();
                return;
            }

            // Validate selection
            const selectedLevel = document.getElementById('selectedLevel').value;
            console.log('Selected level:', selectedLevel);

            if (!selectedLevel) {
                console.log('No level selected - showing error');
                e.preventDefault();
                showError('Please select a class level first.');
                return;
            }

            // Validate CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
            if (!csrfToken || !csrfToken.value) {
                console.log('CSRF token missing');
                e.preventDefault();
                showError('Security token missing. Please refresh the page and try again.');
                return;
            }

            console.log('Form validation passed, submitting...');

            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            submitBtn.classList.add('opacity-75');

            // Use simple form submission - more reliable
            console.log('Submitting form normally...');

            // Let the form submit normally, but add a timeout for user feedback
            setTimeout(() => {
                if (submitBtn.disabled) {
                    console.log('Form submission taking longer than expected');
                    showError('This is taking longer than expected. Please wait or try refreshing the page if nothing happens.');
                }
            }, 8000);

            // Add progress indicator
            let dots = 0;
            const progressInterval = setInterval(() => {
                dots = (dots + 1) % 4;
                const dotString = '.'.repeat(dots);
                submitBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Loading${dotString}`;
            }, 500);

            // Simplified timeout handling
            const timeoutId = setTimeout(() => {
                console.log('Form submission timed out');
                clearInterval(progressInterval);
                if (submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Continue to Dashboard';
                    submitBtn.classList.remove('opacity-75');

                    showError('Request timed out. Please check your internet connection and try again.');
                }
            }, 20000); // 20 second timeout

            // Clear timeout if page unloads (form submitted successfully)
            window.addEventListener('beforeunload', () => {
                clearTimeout(timeoutId);
                clearInterval(progressInterval);
            });
        });
    }
});

// Professional Dashboard Enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Animate hero section
    setTimeout(() => {
        const heroSection = document.querySelector('.dashboard-hero');
        if (heroSection) {
            heroSection.style.opacity = '0';
            heroSection.style.transform = 'translateY(20px)';
            heroSection.style.transition = 'all 0.6s ease';

            setTimeout(() => {
                heroSection.style.opacity = '1';
                heroSection.style.transform = 'translateY(0)';
            }, 100);
        }
    }, 200);

    // Animate stats with counting effect
    function animateStats() {
        const statNumbers = document.querySelectorAll('.stat-number[data-target]');

        statNumbers.forEach((stat, index) => {
            const target = parseInt(stat.getAttribute('data-target'));
            const duration = 1500;
            const increment = target / (duration / 16);
            let current = 0;

            setTimeout(() => {
                const timer = setInterval(() => {
                    current += increment;
                    if (current >= target) {
                        current = target;
                        clearInterval(timer);
                    }
                    stat.textContent = Math.floor(current);
                }, 16);
            }, index * 200);
        });
    }

    // Animate subject cards
    function animateSubjectCards() {
        const subjectCards = document.querySelectorAll('.subject-card');

        subjectCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'all 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 600 + (index * 100));
        });
    }

    // Add hover effects to subject cards
    function addSubjectCardEffects() {
        const subjectCards = document.querySelectorAll('.subject-card');

        subjectCards.forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-5px)';
                this.style.boxShadow = '0 10px 25px rgba(0,0,0,0.1)';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
                this.style.boxShadow = '0 4px 6px rgba(0,0,0,0.05)';
            });
        });
    }

    // Initialize animations
    setTimeout(animateStats, 800);
    setTimeout(animateSubjectCards, 1000);
    setTimeout(addSubjectCardEffects, 1500);

    // Add motivational messages
    function showMotivationalMessage() {
        const messages = [
            "You're doing great! Keep learning! ðŸŒŸ",
            "Every topic completed is progress! ðŸ“š",
            "Knowledge is power! Keep going! ðŸ’ª",
            "You're building your future! ðŸš€",
            "Learning never stops! Stay curious! ðŸ§ "
        ];

        const completedTopics = parseInt(document.querySelector('[data-target]')?.getAttribute('data-target') || 0);

        if (completedTopics > 0 && Math.random() < 0.3) {
            setTimeout(() => {
                const message = messages[Math.floor(Math.random() * messages.length)];
                if (typeof showToast !== 'undefined') {
                    showToast(message, 'success', 4000);
                }
            }, 2000);
        }
    }

    showMotivationalMessage();
});
</script>

{% else %}
<!-- Professional Dashboard -->
<div class="dashboard-container" style="padding-top: 1rem;">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-7xl">

        <!-- Professional Hero Section -->
        <div class="dashboard-hero">
            <div class="hero-content">
                <!-- User Welcome -->
                <div class="hero-header">
                    <div class="hero-avatar">
                        {% if user.profile_picture %}
                            <img src="{{ user.profile_picture.url }}" alt="{{ user.full_name }}" class="hero-avatar-img" />
                        {% else %}
                            <div class="hero-avatar-initials">
                                {{ user.first_name|first|upper }}{{ user.last_name|first|upper }}
                            </div>
                        {% endif %}
                    </div>
                    <div class="hero-info">
                        <h1 class="hero-title">
                            Welcome back, {{ user.first_name }}
                        </h1>
                        <p class="hero-subtitle">
                            {{ user_class_level_name }} Student
                            {% if user.current_class_level %}
                                <span class="hero-grade-badge">{{ user.get_current_class_level_display }}</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                        <!-- Enhanced Stats with Animations -->
                        <div class="hero-stats">
                            <div class="stat-card hover:scale-105 transition-transform duration-200" data-stat="{{ total_subjects }}">
                                <div class="stat-number" data-target="{{ total_subjects }}">0</div>
                                <div class="stat-label">
                                    <i class="fas fa-book text-blue-500 mr-1"></i>
                                    Subjects
                                </div>
                            </div>
                            <div class="stat-card hover:scale-105 transition-transform duration-200" data-stat="{{ completed_subjects }}">
                                <div class="stat-number" data-target="{{ completed_subjects }}">0</div>
                                <div class="stat-label">
                                    <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                    Completed
                                </div>
                            </div>
                            <div class="stat-card hover:scale-105 transition-transform duration-200" data-stat="{{ total_topics }}">
                                <div class="stat-number" data-target="{{ total_topics }}">0</div>
                                <div class="stat-label">
                                    <i class="fas fa-list text-purple-500 mr-1"></i>
                                    Topics
                                </div>
                            </div>
                            <div class="stat-card hover:scale-105 transition-transform duration-200" data-stat="{{ completed_topics }}">
                                <div class="stat-number" data-target="{{ completed_topics }}">0</div>
                                <div class="stat-label">
                                    <i class="fas fa-trophy text-yellow-500 mr-1"></i>
                                    Finished
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Continue Learning Button -->
                    {% if next_learning_path %}
                    <div class="mt-6">
                        <a href="{{ next_learning_path.url }}" class="continue-learning-btn">
                            <i class="fas fa-play mr-2"></i>
                            {{ next_learning_path.title }}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Subscription Promotion (only show if billing is enabled and user doesn't have active subscription) -->
        {% if billing_enabled and not user_subscription.is_active %}
        <div class="dashboard-card mb-6">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg p-6">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-bold mb-2">
                            <i class="fas fa-star mr-2"></i>
                            Unlock Premium Learning
                        </h3>
                        <p class="text-blue-100">
                            Get access to all subjects, unlimited quizzes, and personalized learning paths
                        </p>
                        <div class="flex items-center mt-2 text-sm text-blue-100">
                            <i class="fas fa-check mr-2"></i>
                            <span class="mr-4">All 12 Subjects</span>
                            <i class="fas fa-check mr-2"></i>
                            <span class="mr-4">Unlimited Practice</span>
                            <i class="fas fa-check mr-2"></i>
                            <span>Progress Tracking</span>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <a href="{% url 'billing:plans' %}" class="bg-white text-blue-600 px-6 py-3 rounded-lg font-semibold hover:bg-blue-50 transition-colors">
                            <i class="fas fa-crown mr-2"></i>
                            View Plans
                        </a>
                        <a href="{% url 'billing:dashboard' %}" class="border border-white text-white px-6 py-3 rounded-lg font-semibold hover:bg-white hover:text-blue-600 transition-colors">
                            <i class="fas fa-cog mr-2"></i>
                            Manage Billing
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% elif billing_enabled and user_subscription.is_active %}
        <!-- Active Subscription Status -->
        <div class="dashboard-card mb-6">
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg p-6">
                <div class="flex flex-col md:flex-row items-center justify-between">
                    <div class="mb-4 md:mb-0">
                        <h3 class="text-xl font-bold mb-2">
                            <i class="fas fa-check-circle mr-2"></i>
                            {{ user_subscription.plan.name }} Plan Active
                        </h3>
                        <p class="text-green-100">
                            Your subscription is active until {{ user_subscription.current_period_end|date:"F d, Y" }}
                        </p>
                        <div class="flex items-center mt-2 text-sm text-green-100">
                            <i class="fas fa-calendar mr-2"></i>
                            <span class="mr-4">{{ user_subscription.billing_cycle|title }} Billing</span>
                            <i class="fas fa-unlock mr-2"></i>
                            <span>Full Access Enabled</span>
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <a href="{% url 'billing:dashboard' %}" class="bg-white text-green-600 px-6 py-3 rounded-lg font-semibold hover:bg-green-50 transition-colors">
                            <i class="fas fa-cog mr-2"></i>
                            Manage Subscription
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Progress Overview -->
        <div class="dashboard-card mb-6">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-chart-line mr-3 text-green-600"></i>
                    Your Learning Progress
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Overall Progress -->
                    <div class="bg-gradient-to-r from-blue-50 to-blue-100 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-blue-700 font-semibold">Overall Progress</span>
                            <span class="text-blue-600 text-sm">{{ overall_progress_percentage|floatformat:0 }}%</span>
                        </div>
                        <div class="w-full bg-blue-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 h-3 rounded-full transition-all duration-1000"
                                 style="width: {{ overall_progress_percentage|floatformat:0 }}%"></div>
                        </div>
                        <p class="text-blue-600 text-sm mt-2">Keep up the great work!</p>
                    </div>

                    <!-- Weekly Goal -->
                    <div class="bg-gradient-to-r from-green-50 to-green-100 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-green-700 font-semibold">This Week</span>
                            <span class="text-green-600 text-sm">{{ weekly_progress|default:0 }}/5 topics</span>
                        </div>
                        <div class="w-full bg-green-200 rounded-full h-3">
                            <div class="bg-gradient-to-r from-green-500 to-green-600 h-3 rounded-full transition-all duration-1000"
                                 style="width: {{ weekly_progress_percentage|default:0 }}%"></div>
                        </div>
                        <p class="text-green-600 text-sm mt-2">{{ weekly_message|default:"Start your weekly goal!" }}</p>
                    </div>

                    <!-- Streak -->
                    <div class="bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-orange-700 font-semibold">Learning Streak</span>
                            <span class="text-orange-600 text-sm">{{ learning_streak|default:0 }} days</span>
                        </div>
                        <div class="flex items-center">
                            <i class="fas fa-fire text-orange-500 text-2xl mr-2"></i>
                            <span class="text-orange-600 font-bold text-lg">{{ learning_streak|default:0 }}</span>
                        </div>
                        <p class="text-orange-600 text-sm mt-2">{{ streak_message|default:"Start your streak today!" }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Subjects Grid -->
        <div class="dashboard-card">
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-graduation-cap mr-3 text-blue-600"></i>
                        Your {{ user_class_level_name }} Subjects
                    </h2>
                    <div class="text-sm text-gray-600">
                        {{ completed_subjects }}/{{ total_subjects }} completed
                    </div>
                </div>
            </div>

            <div class="subjects-grid">
                {% for subject_data in current_grade_subjects %}
                <div class="subject-card {% if subject_data.is_completed %}completed{% elif subject_data.completed_topics > 0 %}in-progress{% else %}not-started{% endif %}">
                    <div class="subject-header">
                        <div class="subject-icon" style="background: {{ subject_data.subject.color }}20; color: {{ subject_data.subject.color }};">
                            {{ subject_data.subject.icon }}
                        </div>
                        <div class="subject-info">
                            <h3 class="subject-name">{{ subject_data.subject.name }}</h3>
                            <p class="subject-progress-text">
                                {{ subject_data.completed_topics }}/{{ subject_data.topics_count }} topics completed
                            </p>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="progress-bar">
                        <div class="progress-fill {% if subject_data.is_completed %}completed{% endif %}"
                             style="width: {{ subject_data.completion_percentage }}%"></div>
                    </div>

                    <!-- Subject Actions -->
                    <div class="subject-actions">
                        {% if subject_data.next_topic %}
                            <a href="{{ subject_data.next_topic_url }}" class="action-btn primary">
                                <i class="fas fa-play mr-2"></i>
                                {% if subject_data.completed_topics == 0 %}Start Learning{% else %}Continue{% endif %}
                            </a>
                        {% else %}
                            <span class="action-btn primary" style="opacity: 0.5;">
                                <i class="fas fa-check mr-2"></i>
                                Completed
                            </span>
                        {% endif %}

                        <a href="{% url 'subjects:level_detail' subject_data.subject.id subject_data.class_level.id %}" class="action-btn secondary">
                            <i class="fas fa-list mr-2"></i>
                            View Topics
                        </a>
                    </div>
                </div>
                {% empty %}
                <div class="col-span-full text-center py-8">
                    <i class="fas fa-book text-4xl text-gray-400 mb-4"></i>
                    <p class="text-gray-600">No subjects available for your current grade.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Recent Activity -->
        {% if recent_activity %}
        <div class="dashboard-card">
            <div class="recent-activity">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-clock mr-3 text-green-600"></i>
                    Recent Activity
                </h2>

                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-icon" style="background: {{ activity.topic.class_level.subject.color }}20; color: {{ activity.topic.class_level.subject.color }};">
                        {{ activity.topic.class_level.subject.icon }}
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">{{ activity.topic.title }}</div>
                        <div class="activity-subtitle">
                            {{ activity.topic.class_level.subject.name }} â€¢
                            {% if activity.is_completed %}
                                <span class="text-green-600">Completed</span>
                            {% else %}
                                <span class="text-blue-600">In Progress</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

    </div>
</div>
{% endif %}
{% endblock %}

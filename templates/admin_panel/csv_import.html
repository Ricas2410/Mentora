{% extends 'admin_panel/base.html' %}

{% block title %}Questions Import{% endblock %}
{% block page_title %}Questions Import{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Import Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Import Questions from CSV
                </h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="importForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ form.csv_file.id_for_label }}" class="form-label">
                            Questions CSV File <span class="text-danger">*</span>
                        </label>
                        {{ form.csv_file }}
                        <div class="form-text">
                            Upload a CSV file with questions data (max 5MB). Download the template first to see the required format.
                        </div>
                        {% if form.csv_file.errors %}
                            <div class="text-danger small">{{ form.csv_file.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Progress Bar (hidden initially) -->
                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Uploading and processing...</span>
                            <span id="progressText" class="small text-muted">0%</span>
                        </div>
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div id="statusText" class="small text-muted mt-2">Preparing upload...</div>
                    </div>

                    <!-- Live Preview Section (hidden initially) -->
                    <div id="livePreview" class="mt-4" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-eye me-2 text-info"></i>
                                    Question Preview
                                    <span id="previewStats" class="badge bg-info ms-2"></span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="previewContent">
                                    <!-- Preview content will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{% url 'admin_panel:download_template' %}?type=questions" class="btn btn-outline-info me-2">
                                <i class="fas fa-download me-2"></i>
                                Download Template
                            </a>
                            <a href="{% url 'admin_panel:import_logs' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-list-alt me-2"></i>
                                View Import Logs
                            </a>
                        </div>
                        <div>
                            <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">
                                <i class="fas fa-upload me-2"></i>
                                <span id="submitText">Import Questions</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recent Imports -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Imports
                </h5>
            </div>
            <div class="card-body">
                {% if recent_imports %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Total Rows</th>
                                    <th>Success</th>
                                    <th>Failed</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for import_log in recent_imports %}
                                    <tr>
                                        <td>{{ import_log.file_name }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ import_log.import_type|title }}</span>
                                        </td>
                                        <td>
                                            {% if import_log.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif import_log.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% elif import_log.status == 'processing' %}
                                                <span class="badge bg-warning">Processing</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ import_log.total_rows }}</td>
                                        <td>
                                            <span class="text-success">{{ import_log.successful_imports }}</span>
                                        </td>
                                        <td>
                                            <span class="text-danger">{{ import_log.failed_imports }}</span>
                                        </td>
                                        <td>{{ import_log.started_at|date:"M d, Y H:i" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-csv fs-1 text-muted mb-3"></i>
                        <p class="text-muted">No imports yet. Upload your first CSV file to get started.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Import Guidelines -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Import Guidelines
                </h5>
            </div>
            <div class="card-body">
                <h6>Required Fields:</h6>
                <ul class="small">
                    <li><strong>subject_name:</strong> Subject (must exist)</li>
                    <li><strong>class_level_name:</strong> Class level (must exist)</li>
                    <li><strong>topic_title:</strong> Topic (must exist)</li>
                    <li><strong>question_text:</strong> The question</li>
                    <li><strong>question_type:</strong> multiple_choice, fill_blank, true_false, short_answer</li>
                    <li><strong>correct_answer:</strong> Correct answer</li>
                </ul>

                <h6 class="mt-3">Optional Fields:</h6>
                <ul class="small">
                    <li><strong>explanation:</strong> Answer explanation</li>
                    <li><strong>difficulty:</strong> easy, medium, hard</li>
                    <li><strong>points:</strong> Points (default: 1)</li>
                    <li><strong>time_limit:</strong> Seconds (default: 45)</li>
                    <li><strong>choice_a to choice_d:</strong> Multiple choice options</li>
                </ul>

                <div class="alert alert-info small mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Download the template with samples to see the exact format and examples.
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    Export Data
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Export your data for backup or migration purposes.</p>

                <div class="d-grid gap-2">
                    <a href="{% url 'admin_panel:download_template' %}?type=questions" class="btn btn-outline-primary">
                        <i class="fas fa-file-csv me-2"></i>
                        Questions Template
                    </a>
                    <a href="{% url 'admin_panel:export_questions' %}" class="btn btn-outline-success">
                        <i class="fas fa-database me-2"></i>
                        Export All Questions
                    </a>
                    <a href="{% url 'admin_panel:export_users' %}" class="btn btn-outline-info">
                        <i class="fas fa-users me-2"></i>
                        Export Users
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Import Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ recent_imports|length }}</h4>
                        <small class="text-muted">Total Imports</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">
                            {% for import_log in recent_imports %}
                                {% if import_log.status == 'completed' %}{{ forloop.counter0|add:1 }}{% endif %}
                            {% empty %}0{% endfor %}
                        </h4>
                        <small class="text-muted">Successful</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // File input validation
    const fileInput = document.getElementById('{{ form.csv_file.id_for_label }}');
    const importForm = document.getElementById('importForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusText = document.getElementById('statusText');
    const livePreview = document.getElementById('livePreview');
    const previewContent = document.getElementById('previewContent');
    const previewStats = document.getElementById('previewStats');

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file.');
                this.value = '';
                livePreview.style.display = 'none';
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size should not exceed 5MB.');
                this.value = '';
                livePreview.style.display = 'none';
                return;
            }

            // Show file info and automatically generate preview
            statusText.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            generateLivePreview(file);
        } else {
            livePreview.style.display = 'none';
            submitBtn.style.display = 'none';
        }
    });

    // Function to generate live preview automatically
    function generateLivePreview(file) {
        // Show loading state
        livePreview.style.display = 'block';
        previewContent.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin me-2"></i>Loading preview...</div>';
        previewStats.textContent = 'Loading...';

        // Create FormData and send preview request
        const formData = new FormData();
        formData.append('csv_file', file);
        formData.append('action', 'preview');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayLivePreview(data.preview_data);

                // Show import button if no critical errors
                if (data.preview_data.summary.rows_with_errors === 0) {
                    submitBtn.style.display = 'inline-block';
                } else {
                    submitBtn.style.display = 'none';
                }
            } else {
                previewContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Preview Failed:</strong> ${data.error}
                    </div>
                `;
                previewStats.textContent = 'Error';
                submitBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            previewContent.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> Failed to generate preview. Please check your CSV file format.
                </div>
            `;
            previewStats.textContent = 'Error';
            submitBtn.style.display = 'none';
        });
    }



    // Handle form submission with progress
    importForm.addEventListener('submit', function(e) {
        const file = fileInput.files[0];
        if (!file) {
            alert('Please select a CSV file first.');
            e.preventDefault();
            return;
        }

        // Add action field to form for import
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'import';
        importForm.appendChild(actionInput);

        // Show progress bar
        uploadProgress.style.display = 'block';
        submitBtn.disabled = true;
        submitText.textContent = 'Processing...';

        // Simulate progress (since we can't track actual server processing)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) {
                progress = 90;
                clearInterval(progressInterval);
                statusText.textContent = 'Finalizing import...';
            }

            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = Math.round(progress) + '%';

            if (progress < 30) {
                statusText.textContent = 'Uploading file...';
            } else if (progress < 60) {
                statusText.textContent = 'Validating data...';
            } else if (progress < 90) {
                statusText.textContent = 'Processing questions...';
            }
        }, 200);

        // The form will submit normally, and the page will reload with results
    });

    // Function to display live preview with formatted questions
    function displayLivePreview(previewData) {
        // Update stats badge
        const totalQuestions = previewData.summary.total_rows;
        const errorCount = previewData.summary.rows_with_errors;
        const warningCount = previewData.summary.rows_with_warnings;

        if (errorCount > 0) {
            previewStats.textContent = `${totalQuestions} questions, ${errorCount} errors`;
            previewStats.className = 'badge bg-danger ms-2';
        } else if (warningCount > 0) {
            previewStats.textContent = `${totalQuestions} questions, ${warningCount} warnings`;
            previewStats.className = 'badge bg-warning ms-2';
        } else {
            previewStats.textContent = `${totalQuestions} questions, ready to import`;
            previewStats.className = 'badge bg-success ms-2';
        }

        let html = '';

        // Show validation issues if any
        if (previewData.validation_results.length > 0) {
            html += `
                <div class="alert alert-${errorCount > 0 ? 'danger' : 'warning'} mb-3">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Issues Found</h6>
                    <div class="small">
                        ${previewData.validation_results.slice(0, 3).map(result => `
                            <div class="mb-1">
                                <strong>Row ${result.row_number}:</strong>
                                ${result.issues.concat(result.warnings).join(', ')}
                            </div>
                        `).join('')}
                        ${previewData.validation_results.length > 3 ? `<div class="text-muted">... and ${previewData.validation_results.length - 3} more issues</div>` : ''}
                    </div>
                </div>
            `;
        }

        // Show formatted questions preview
        if (previewData.sample_rows.length > 0) {
            html += '<h6 class="mb-3">Question Preview (First 3 Questions)</h6>';

            previewData.sample_rows.slice(0, 3).forEach((row, index) => {
                const questionType = row.question_type || 'unknown';
                const questionText = row.question_text || 'No question text';
                const subject = row.subject_name || 'Unknown Subject';
                const topic = row.topic_title || 'Unknown Topic';
                const difficulty = row.difficulty || 'medium';

                // Difficulty badge color
                const difficultyClass = {
                    'easy': 'bg-success',
                    'medium': 'bg-warning',
                    'hard': 'bg-danger'
                }[difficulty] || 'bg-secondary';

                html += `
                    <div class="card mb-3 border-start border-4 border-primary">
                        <div class="card-header bg-light py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-primary me-2">${subject}</span>
                                    <span class="badge bg-secondary me-2">${topic}</span>
                                    <span class="badge ${difficultyClass}">${difficulty}</span>
                                </div>
                                <small class="text-muted">Question ${index + 1}</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${questionText}</h6>
                            ${formatQuestionByType(row, questionType)}
                        </div>
                    </div>
                `;
            });
        }

        previewContent.innerHTML = html;
    }

    // Function to format questions based on type
    function formatQuestionByType(row, questionType) {
        switch (questionType) {
            case 'multiple_choice':
                const choices = [
                    { letter: 'A', text: row.choice_a || '' },
                    { letter: 'B', text: row.choice_b || '' },
                    { letter: 'C', text: row.choice_c || '' },
                    { letter: 'D', text: row.choice_d || '' }
                ].filter(choice => choice.text.trim());

                const correctAnswer = (row.correct_answer || '').toUpperCase();

                return `
                    <div class="mt-3">
                        ${choices.map(choice => `
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="radio" disabled ${choice.letter === correctAnswer ? 'checked' : ''}>
                                <label class="form-check-label ${choice.letter === correctAnswer ? 'text-success fw-bold' : ''}">
                                    <strong>${choice.letter}.</strong> ${choice.text}
                                    ${choice.letter === correctAnswer ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                                </label>
                            </div>
                        `).join('')}
                    </div>
                `;

            case 'true_false':
                const correctAnswer_tf = (row.correct_answer || '').toLowerCase();
                const isTrue = ['true', 't', '1', 'yes'].includes(correctAnswer_tf);

                return `
                    <div class="mt-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" disabled ${isTrue ? 'checked' : ''}>
                            <label class="form-check-label ${isTrue ? 'text-success fw-bold' : ''}">
                                True ${isTrue ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" disabled ${!isTrue ? 'checked' : ''}>
                            <label class="form-check-label ${!isTrue ? 'text-success fw-bold' : ''}">
                                False ${!isTrue ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                            </label>
                        </div>
                    </div>
                `;

            case 'fill_blank':
            case 'short_answer':
                return `
                    <div class="mt-3">
                        <div class="form-floating">
                            <input type="text" class="form-control" placeholder="Type your answer here..." disabled>
                            <label>Type your answer here...</label>
                        </div>
                        <div class="mt-2">
                            <small class="text-success">
                                <i class="fas fa-key me-1"></i>
                                <strong>Correct Answer:</strong> ${row.correct_answer || 'Not specified'}
                            </small>
                        </div>
                    </div>
                `;

            default:
                return `
                    <div class="mt-3">
                        <div class="alert alert-warning small">
                            <i class="fas fa-question-circle me-2"></i>
                            Unknown question type: ${questionType}
                        </div>
                    </div>
                `;
        }
    }

    // Reset form state if there are errors
    {% if form.errors %}
        uploadProgress.style.display = 'none';
        submitBtn.disabled = false;
        submitText.textContent = 'Import Questions';
    {% endif %}
});
</script>
{% endblock %}

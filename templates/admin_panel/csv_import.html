{% extends 'admin_panel/base.html' %}

{% block title %}Questions Import{% endblock %}
{% block page_title %}Questions Import{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- Import Section -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-upload me-2"></i>
                    Import Questions from CSV
                </h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="importForm">
                    {% csrf_token %}

                    <div class="mb-3">
                        <label for="{{ form.csv_file.id_for_label }}" class="form-label">
                            Questions CSV File <span class="text-danger">*</span>
                        </label>
                        {{ form.csv_file }}
                        <div class="form-text">
                            Upload a CSV file with questions data (max 5MB). Download the template first to see the required format.
                        </div>
                        {% if form.csv_file.errors %}
                            <div class="text-danger small">{{ form.csv_file.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <!-- Progress Bar (hidden initially) -->
                    <div id="uploadProgress" class="mb-3" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Uploading and processing...</span>
                            <span id="progressText" class="small text-muted">0%</span>
                        </div>
                        <div class="progress">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                        <div id="statusText" class="small text-muted mt-2">Preparing upload...</div>
                    </div>

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <a href="{% url 'admin_panel:download_template' %}?type=questions" class="btn btn-outline-info me-2">
                                <i class="fas fa-download me-2"></i>
                                Download Template
                            </a>
                            <a href="{% url 'admin_panel:import_logs' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-list-alt me-2"></i>
                                View Import Logs
                            </a>
                        </div>
                        <div>
                            <button type="button" id="previewBtn" class="btn btn-warning me-2">
                                <i class="fas fa-eye me-2"></i>
                                Preview Data
                            </button>
                            <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">
                                <i class="fas fa-upload me-2"></i>
                                <span id="submitText">Import Questions</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Recent Imports -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Imports
                </h5>
            </div>
            <div class="card-body">
                {% if recent_imports %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Total Rows</th>
                                    <th>Success</th>
                                    <th>Failed</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for import_log in recent_imports %}
                                    <tr>
                                        <td>{{ import_log.file_name }}</td>
                                        <td>
                                            <span class="badge bg-info">{{ import_log.import_type|title }}</span>
                                        </td>
                                        <td>
                                            {% if import_log.status == 'completed' %}
                                                <span class="badge bg-success">Completed</span>
                                            {% elif import_log.status == 'failed' %}
                                                <span class="badge bg-danger">Failed</span>
                                            {% elif import_log.status == 'processing' %}
                                                <span class="badge bg-warning">Processing</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ import_log.total_rows }}</td>
                                        <td>
                                            <span class="text-success">{{ import_log.successful_imports }}</span>
                                        </td>
                                        <td>
                                            <span class="text-danger">{{ import_log.failed_imports }}</span>
                                        </td>
                                        <td>{{ import_log.started_at|date:"M d, Y H:i" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-csv fs-1 text-muted mb-3"></i>
                        <p class="text-muted">No imports yet. Upload your first CSV file to get started.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Import Guidelines -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Import Guidelines
                </h5>
            </div>
            <div class="card-body">
                <h6>Required Fields:</h6>
                <ul class="small">
                    <li><strong>subject_name:</strong> Subject (must exist)</li>
                    <li><strong>class_level_name:</strong> Class level (must exist)</li>
                    <li><strong>topic_title:</strong> Topic (must exist)</li>
                    <li><strong>question_text:</strong> The question</li>
                    <li><strong>question_type:</strong> multiple_choice, fill_blank, true_false, short_answer</li>
                    <li><strong>correct_answer:</strong> Correct answer</li>
                </ul>

                <h6 class="mt-3">Optional Fields:</h6>
                <ul class="small">
                    <li><strong>explanation:</strong> Answer explanation</li>
                    <li><strong>difficulty:</strong> easy, medium, hard</li>
                    <li><strong>points:</strong> Points (default: 1)</li>
                    <li><strong>time_limit:</strong> Seconds (default: 45)</li>
                    <li><strong>choice_a to choice_d:</strong> Multiple choice options</li>
                </ul>

                <div class="alert alert-info small mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Tip:</strong> Download the template with samples to see the exact format and examples.
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    Export Data
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted small">Export your data for backup or migration purposes.</p>

                <div class="d-grid gap-2">
                    <a href="{% url 'admin_panel:download_template' %}?type=questions" class="btn btn-outline-primary">
                        <i class="fas fa-file-csv me-2"></i>
                        Questions Template
                    </a>
                    <a href="{% url 'admin_panel:export_questions' %}" class="btn btn-outline-success">
                        <i class="fas fa-database me-2"></i>
                        Export All Questions
                    </a>
                    <a href="{% url 'admin_panel:export_users' %}" class="btn btn-outline-info">
                        <i class="fas fa-users me-2"></i>
                        Export Users
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Import Statistics
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h4 class="text-primary">{{ recent_imports|length }}</h4>
                        <small class="text-muted">Total Imports</small>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">
                            {% for import_log in recent_imports %}
                                {% if import_log.status == 'completed' %}{{ forloop.counter0|add:1 }}{% endif %}
                            {% empty %}0{% endfor %}
                        </h4>
                        <small class="text-muted">Successful</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="previewModalLabel">
                    <i class="fas fa-eye me-2"></i>
                    CSV Import Preview
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="previewContent">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="proceedImportBtn" class="btn btn-primary">
                    <i class="fas fa-upload me-2"></i>
                    Proceed with Import
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // File input validation
    const fileInput = document.getElementById('{{ form.csv_file.id_for_label }}');
    const importForm = document.getElementById('importForm');
    const submitBtn = document.getElementById('submitBtn');
    const previewBtn = document.getElementById('previewBtn');
    const proceedImportBtn = document.getElementById('proceedImportBtn');
    const submitText = document.getElementById('submitText');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusText = document.getElementById('statusText');
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    const previewContent = document.getElementById('previewContent');

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            if (!file.name.toLowerCase().endsWith('.csv')) {
                alert('Please select a CSV file.');
                this.value = '';
                return;
            }

            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                alert('File size should not exceed 5MB.');
                this.value = '';
                return;
            }

            // Show file info and enable preview button
            statusText.textContent = `Selected: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
            previewBtn.disabled = false;
        } else {
            previewBtn.disabled = true;
            submitBtn.style.display = 'none';
        }
    });

    // Handle preview button click
    previewBtn.addEventListener('click', function() {
        const file = fileInput.files[0];
        if (!file) {
            alert('Please select a CSV file first.');
            return;
        }

        // Show loading state
        previewBtn.disabled = true;
        previewBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading Preview...';

        // Create FormData and send preview request
        const formData = new FormData();
        formData.append('csv_file', file);
        formData.append('action', 'preview');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

        fetch(window.location.href, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayPreview(data.preview_data);
                previewModal.show();
            } else {
                alert('Preview failed: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to generate preview. Please try again.');
        })
        .finally(() => {
            // Reset preview button
            previewBtn.disabled = false;
            previewBtn.innerHTML = '<i class="fas fa-eye me-2"></i>Preview Data';
        });
    });

    // Handle proceed with import button
    proceedImportBtn.addEventListener('click', function() {
        // Add action field to form and submit
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'import';
        importForm.appendChild(actionInput);

        previewModal.hide();
        submitBtn.style.display = 'inline-block';
        submitBtn.click();
    });

    // Handle form submission with progress
    importForm.addEventListener('submit', function(e) {
        const file = fileInput.files[0];
        if (!file) {
            alert('Please select a CSV file first.');
            e.preventDefault();
            return;
        }

        // Show progress bar
        uploadProgress.style.display = 'block';
        submitBtn.disabled = true;
        submitText.textContent = 'Processing...';

        // Simulate progress (since we can't track actual server processing)
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) {
                progress = 90;
                clearInterval(progressInterval);
                statusText.textContent = 'Finalizing import...';
            }

            progressBar.style.width = progress + '%';
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = Math.round(progress) + '%';

            if (progress < 30) {
                statusText.textContent = 'Uploading file...';
            } else if (progress < 60) {
                statusText.textContent = 'Validating data...';
            } else if (progress < 90) {
                statusText.textContent = 'Processing questions...';
            }
        }, 200);

        // The form will submit normally, and the page will reload with results
    });

    // Function to display preview data
    function displayPreview(previewData) {
        let html = `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary">${previewData.summary.total_rows}</h5>
                            <p class="card-text small">Total Rows</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-danger">${previewData.summary.rows_with_errors}</h5>
                            <p class="card-text small">Rows with Errors</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning">${previewData.summary.rows_with_warnings}</h5>
                            <p class="card-text small">Rows with Warnings</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success">${Math.round(previewData.summary.estimated_success_rate)}%</h5>
                            <p class="card-text small">Success Rate</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Show validation issues if any
        if (previewData.validation_results.length > 0) {
            html += `
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Validation Issues Found</h6>
                    <div class="accordion" id="validationAccordion">
            `;

            previewData.validation_results.forEach((result, index) => {
                const badgeClass = result.status === 'error' ? 'bg-danger' : 'bg-warning';
                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                Row ${result.row_number} <span class="badge ${badgeClass} ms-2">${result.status}</span>
                            </button>
                        </h2>
                        <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#validationAccordion">
                            <div class="accordion-body">
                                ${result.issues.map(issue => `<div class="text-danger small">• ${issue}</div>`).join('')}
                                ${result.warnings.map(warning => `<div class="text-warning small">• ${warning}</div>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    </div>
                </div>
            `;
        }

        // Show sample data
        if (previewData.sample_rows.length > 0) {
            html += `
                <h6>Sample Data (First 5 Rows)</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                ${previewData.headers.map(header => `<th class="small">${header}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${previewData.sample_rows.map(row => `
                                <tr>
                                    ${previewData.headers.map(header => `<td class="small">${row[header] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        previewContent.innerHTML = html;

        // Enable/disable proceed button based on errors
        proceedImportBtn.disabled = previewData.summary.rows_with_errors > 0;
        if (previewData.summary.rows_with_errors > 0) {
            proceedImportBtn.innerHTML = '<i class="fas fa-times me-2"></i>Cannot Import (Errors Found)';
            proceedImportBtn.className = 'btn btn-danger';
        } else {
            proceedImportBtn.innerHTML = '<i class="fas fa-upload me-2"></i>Proceed with Import';
            proceedImportBtn.className = 'btn btn-primary';
        }
    }

    // Reset form state if there are errors
    {% if form.errors %}
        uploadProgress.style.display = 'none';
        submitBtn.disabled = false;
        submitText.textContent = 'Import Questions';
    {% endif %}
});
</script>
{% endblock %}
